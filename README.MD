# üß© Microservices Communication

---

## üó£Ô∏è What is Microservices Communication?

When one¬†**Microservice (MS)**¬†wants to¬†**send a request and receive a response**¬†from another MS,

that interaction is called¬†**Microservice Communication**.

> All microservices here are Spring Boot REST applications.
>

Traditionally, we could use¬†`RestTemplate`¬†for inter-service calls,¬†**but hardcoding URLs is bad practice**¬†because:

- ‚úÖ MS instances may run on¬†**different systems (dynamic IPs)**
- ‚úÖ Multiple instances may exist for¬†**load balancing**

---

## ‚òÅÔ∏è Spring Cloud Communication APIs

Spring Cloud provides several client-side communication mechanisms:

| API | Type | Description |
| --- | --- | --- |
| **1Ô∏è‚É£ DiscoveryClient** | *Legacy* | Fetch instance details from Eureka |
| **2Ô∏è‚É£ LoadBalancerClient** | *Enhanced* | Provides built-in load balancing |
| **3Ô∏è‚É£ OpenFeign Client** | *Modern* | Declarative HTTP client for microservices |

> üß† These clients help¬†link two MS apps¬†for¬†communication only.
>

---

# üõ†Ô∏è¬†1)¬†*DiscoveryClient*

## üß≠ DiscoveryClient

**DiscoveryClient**¬†is provided by¬†**Spring Cloud**¬†to get details of a registered MS from¬†**Eureka Server**,

based on the¬†**Service ID**¬†(application name).

```java
List<ServiceInstance> list = discoveryClient.getInstances("SERVICE-ID");

```

Each¬†`ServiceInstance`¬†contains:

```
serviceId + instanceId + URI (HOST + PORT) + other metadata

```

If there‚Äôs only one instance of a service:

- The result list has¬†**one element (index 0)**.
- From it, we can get the¬†`URI`¬†and construct the¬†**full URL**¬†by appending the path.
- Use¬†`RestTemplate`¬†to call and get a response.

---

### ‚ùì Common Q&A

**Q:**¬†Why use¬†`DiscoveryClient`?

**A:**¬†To¬†**fetch MS details from Eureka Server at runtime**¬†(based on¬†`serviceId`).

**Q:**¬†Can¬†`DiscoveryClient`¬†send HTTP requests to another MS?

**A:**¬†‚ùå No. It only connects to¬†**Eureka Server**, not to other microservices.

**Q:**¬†Can¬†`Eureka Server`¬†call MS apps?

**A:**¬†‚ùå Never. It only stores and provides registration details.

**Q:**¬†What is a¬†`ServiceInstance`?

**A:**¬†Represents one MS instance.

`ServiceInstance = serviceId + instanceId + URI(IP/PORT) + ...`

---

### üåê URI vs URL Breakdown

Example:

```
http://192.168.10.11:8086/myapp/employee/find/101

```

| Component | Description |
| --- | --- |
| **Protocol** | http |
| **IP** | 192.168.10.11 |
| **Port** | 8086 |
| **Context Path** | /myapp |
| **Resource Path** | /employee/find/101 |
| **URI** | IP + PORT |
| **URL** | Protocol + URI + ContextPath + ResourcePath |

---

## üß± Example Architecture

```mermaid
graph TD

subgraph Eureka["Eureka Server (8761)"]
    ES[(Service Registry)]
end

subgraph CartService["Cart Service (8081)"]
    CAPI[/GET /cart/info/]
end

subgraph OrderService["Order Service (8094)"]
    OAPI[/GET /order/place/]
end

OAPI -->|DiscoveryClient| ES
ES -->|ServiceInstance Info| OAPI
OAPI -->|RestTemplate call| CAPI
CAPI -->|Response| OAPI

```

> üèó¬†Flow:
>
>
> OrderService ‚Üí (uses DiscoveryClient to fetch CART-SERVICE URI from Eureka) ‚Üí
>
> Calls¬†`/cart/info`¬†using¬†`RestTemplate`¬†‚Üí Returns combined response.
>

---

## ‚öôÔ∏è Implementation Steps

### 1Ô∏è‚É£ Eureka Server

**Project:**¬†`SpringCloudEurekaServer`

**Dependency:**¬†Eureka Server

**Main Class:**¬†`@EnableEurekaServer`

**`application.properties`**

```
spring.application.name=SpringCloudEurekaServer

# RECOMANDED PORT NUMBER
server.port=8761

# DISABLE SELF REGISTER
eureka.client.register-with-eureka=false
eureka.client.fetch-registry=false
```

---

### 2Ô∏è‚É£ Cart Service

**Project:**¬†`SpringCloudCartService`

**Dependencies:**¬†Spring Web, Eureka Discovery Client

**Main:**¬†`@EnableDiscoveryClient`

**`application.properties`**

```
#PORT
server.port=8081

# ServiceId (app Name)
spring.application.name=CART-SERVICE

#Provide eureka location
eureka.client.service-url.defaultZone=http://localhost:8761/eureka

# Register with Eureka (optional by default these are true )
eureka.client.register-with-eureka=true
# Enable Fetching other MS# Details
eureka.client.fetch-registry=true
```

**`CartRestController.java`**

```java
package com.yog.eureka.discoveryclient.springcloudcartservicediscoveryclient.controller;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/cart")
public class CartRestController {

    @GetMapping("/info")
    public ResponseEntity<String> showMessage() {
        return ResponseEntity.ok("WELCOME TO CART SERVICE");
    }
}

```

---

### 3Ô∏è‚É£ Order Service

**Project:**¬†`SpringCloudOrderService`

**Main:**¬†`@EnableDiscoveryClient`

**`application.properties`**

```
#PORT
server.port=8094

# ServiceId (app Name)
spring.application.name=ORDER-SERVICE

#Provide eureka location
eureka.client.service-url.defaultZone=http://localhost:8761/eureka

```

**`CartConsumer.java`**

```java
package com.yog.eureka.discoveryclient.springcloudorderservicediscoveryclient.consumer;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.net.URI;
import java.util.List;

@Component
public class CartConsumerUsingDiscoveryClient {

    //Impl class is : EurekaDiscoveryClient -- given by Netflix Eureka
    @Autowired
    private DiscoveryClient client;

    public String getCartResponse() {
        // Goto Eureka server with serviceId
        List<ServiceInstance> list = client.getInstances("CART-SERVICE");

        // read at index#0 ==> returns SI
        ServiceInstance si = list.get(0);

        // read URI
        URI uri = si.getUri();

        // add path ==> return URL
        String url = uri + "/cart/info";

        // use RestTemplate and call
        RestTemplate rt = new RestTemplate();

        //make HTTP Request and get response
        ResponseEntity<String> response = rt.getForEntity(url, String.class);

        //return response body
        return response.getBody();
    }
}

```

**`OrderRestController.java`**

```java
package com.yog.eureka.discoveryclient.springcloudorderservicediscoveryclient.controller;

import com.yog.eureka.discoveryclient.springcloudorderservicediscoveryclient.consumer.CartConsumerUsingDiscoveryClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/order")
public class OrderRestController {

    @Autowired
    private CartConsumerUsingDiscoveryClient consumer;

    @GetMapping("/place")
    public ResponseEntity<String> placeOrder() {
        String cartResp = consumer.getCartResponse();
        return ResponseEntity.ok("ORDER PLACED WITH => " + cartResp);
    }

}
```

---

## ‚ñ∂Ô∏è Execution Flow

1. Run¬†**Eureka Server**
2. Run¬†**Cart Service**
3. Run¬†**Order Service**
4. Open¬†**Eureka Dashboard:**

   üîó¬†`http://localhost:8761`

5. Verify that both services are registered.
6. Call from browser/postman:

   üîó¬†`http://localhost:8094/order/place`


**‚úÖ Output:**

```
ORDER PLACED WITH => WELCOME TO CART SERVICE

```

---

## üß† Summary

| Concept | Description |
| --- | --- |
| **DiscoveryClient** | Fetches service details from Eureka |
| **Eureka Server** | Service registry for microservices |
| **RestTemplate** | Makes actual HTTP calls |
| **ServiceInstance** | Represents one running MS instance |
| **Order ‚Üí Cart flow** | DiscoveryClient + RestTemplate based call |

---




# üõ†Ô∏è¬†2)¬†**LoadBalancerClient**

---

# ‚öôÔ∏è Microservices Communication ‚Äî¬†*LoadBalancerClient*

---

## üß© Why Load Balancing Matters

When a microservice application runs¬†**multiple instances**¬†(on different servers or ports), it‚Äôs to:

- ‚ö°¬†**Improve performance**
- ‚öñÔ∏è¬†**Distribute load evenly**¬†among instances
- üß†¬†**Increase availability**¬†and fault tolerance

However, when using¬†**DiscoveryClient**, it only gives back a¬†**List of all ServiceInstances**, and you have to choose one manually.

That‚Äôs where¬†`LoadBalancerClient`¬†helps.

---

## üß† What is LoadBalancerClient?

**LoadBalancerClient**¬†is a¬†**Spring Cloud**¬†interface that automatically chooses¬†**one instance**¬†of a service with the least load factor.

> Internally, it follows a¬†Round Robin¬†or similar¬†load-balancing algorithm.
>

---

### üöÄ Key Points

1Ô∏è‚É£ If you run the same MS multiple times ‚Üí multiple¬†**instances**¬†are created.

2Ô∏è‚É£¬†`DiscoveryClient`¬†returns all instances ‚Äî but¬†**does not**¬†help in choosing one.

3Ô∏è‚É£¬†`LoadBalancerClient`¬†picks¬†**one instance**¬†automatically.

4Ô∏è‚É£ Used for¬†**Client-Side Load Balancing**.

5Ô∏è‚É£ When using multiple instances, configure a unique instance ID:

```
eureka.instance.instance-id=${spring.application.name}:${random.value}

```

---

## üì¶ Components Overview

| Component | Role | Port | Notes |
| --- | --- | --- | --- |
| **Eureka Server** | Service Registry | `8761` | Stores service metadata |
| **Cart Service** | Producer | `8081`,¬†`8082`,¬†`8083` | Registered multiple times |
| **Order Service** | Consumer | `9091` | Uses LoadBalancerClient |

---

## ‚òÅÔ∏è How LoadBalancerClient Works

```mermaid
graph TD

%% ===========================
%%  SPRING CLOUD LOADBALANCER
%% ===========================

subgraph Eureka["Eureka Server (8761)"]
    ES[(Service Registry)]
end

subgraph CartServices["CART-SERVICE Instances"]
    C1["Cart Service #1 (8081)"]
    C2["Cart Service #2 (8082)"]
    C3["Cart Service #3 (8083)"]
end

subgraph OrderService["ORDER-SERVICE (9091)"]
    OAPI["/GET /order/place"]
end

%% Connections
OAPI -->|"Request ServiceInstance"| ES
ES -->|"One instance (Round Robin)"| OAPI

%% Separate HTTP calls for visualization
OAPI -->|"HTTP Request via RestTemplate"| C1
OAPI -->|"HTTP Request via RestTemplate"| C2
OAPI -->|"HTTP Request via RestTemplate"| C3

C1 -->|"Response"| OAPI
C2 -->|"Response"| OAPI
C3 -->|"Response"| OAPI

```

> ‚öñÔ∏è Each request from¬†Order Service¬†may go to a¬†different Cart Service instance, depending on the round-robin selection.
>

---

## üèóÔ∏è Implementation Steps

### 1Ô∏è‚É£ Eureka Server

**Project:**¬†`SpringCloudEurekaServer`

**Dependency:**¬†Eureka Server

**Main:**¬†`@EnableEurekaServer`

**`application.properties`**

```
spring.application.name=SpringCloudEurekaServer

# RECOMANDED PORT NUMBER
server.port=8761

# DISABLE SELF REGISTER
eureka.client.register-with-eureka=false
eureka.client.fetch-registry=false
```

---

### 2Ô∏è‚É£ Cart Service (Producer)

**Project:**¬†`SpringCloudCartService`

**Dependencies:**¬†Spring Web, Eureka Discovery Client

**Main:**¬†`@EnableDiscoveryClient`

**`application.properties`**

```
# Example for 3 different instances
server.port=8081  # change to 8082, 8083 for other runs

spring.application.name=CART-SERVICE
eureka.client.service-url.defaultZone=http://localhost:8761/eureka

# Unique instance ID
eureka.instance.instance-id=${spring.application.name}:${random.value}

```

**`CartRestController.java`**

```java
package com.yog.eureka.loadbalclient.springcloudcartserviceloadbalclient.controller;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/cart")
public class CartRestController {

    @Value("${server.port}")
    private String port;

    @GetMapping("/info")
    public ResponseEntity<String> showMessage() {
        return ResponseEntity.ok("WELCOME TO CART SERVICE =>" + port);
    }
}
```

---

### 3Ô∏è‚É£ Order Service (Consumer)

**Project:**¬†`SpringCloudOrderService`

**Dependencies:**¬†Spring Web, Eureka Discovery Client, Spring Cloud LoadBalancer

**Main:**¬†`@EnableDiscoveryClient`

**`application.properties`**

```
server.port=9091
spring.application.name=ORDER-SERVICE
eureka.client.service-url.defaultZone=http://localhost:8761/eureka

```

**`CartConsumer.java`**

```java
package com.yog.eureka.loadbalclient.springcloudorderserviceloadbalclient.consumer;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.loadbalancer.LoadBalancerClient;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

@Component
public class CartConsumer {

    @Autowired
    private LoadBalancerClient loadBalancerClient;

    public String getCartResponse() {
        ServiceInstance choose = loadBalancerClient.choose("CART-SERVICE");
        String url = choose.getUri() + "/cart/info";
        System.out.println("*********************** " + url + " **********************");

        RestTemplate rt = new RestTemplate();
        ResponseEntity<String> response = rt.getForEntity(url, String.class);
        return response.getBody();
    }
}

```

**`OrderRestController.java`**

```java
package com.yog.eureka.loadbalclient.springcloudorderserviceloadbalclient;

import com.yog.eureka.loadbalclient.springcloudorderserviceloadbalclient.consumer.CartConsumer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/order")
public class OrderRestController {

    @Autowired
    private CartConsumer consumer;

    @GetMapping("/place")
    public ResponseEntity<String> placeOrder() {
        String cartResp = consumer.getCartResponse();
        return ResponseEntity.ok("ORDER PLACED WITH => " + cartResp);
    }

}

```

---

## ‚ñ∂Ô∏è Execution Order

1Ô∏è‚É£ Start¬†**Eureka Server**

2Ô∏è‚É£ Run¬†**Cart Service**¬†three times on different ports (`8081`,¬†`8082`,¬†`8083`)

![image.png](attachment:99cae972-6c09-4023-901a-46a0779b4e3d:image.png)

3Ô∏è‚É£ Start¬†**Order Service**

4Ô∏è‚É£ Open¬†**Eureka Dashboard:**

üîó¬†`http://localhost:8761`

5Ô∏è‚É£ Confirm all services are registered.

6Ô∏è‚É£ Hit endpoint:

üîó¬†`http://localhost:9091/order/place`

Each time you refresh, you‚Äôll see responses like:

```
ORDER PLACED WITH => WELCOME TO CART SERVICE =>8081
ORDER PLACED WITH => WELCOME TO CART SERVICE =>8082
ORDER PLACED WITH => WELCOME TO CART SERVICE =>8083

```

> üí° Notice the changing port ‚Üí means LoadBalancerClient is distributing requests across instances.
>

---

## üí¨ Q&A Summary

| Question | Answer |
| --- | --- |
| **Why use LoadBalancerClient?** | To work with multiple instances of the same service. Performs¬†**Client-Side Load Balancing**. |
| **Old Load Balancer Vendor?** | üéØ Ribbon (now deprecated). |
| **Current Load Balancer?** | üÜï Spring Cloud LoadBalancer. |
| **How many instances are returned per request?** | Only¬†**one**¬†(based on algorithm). |
| **Is RestTemplate still required?** | ‚úÖ Yes ‚Äî LoadBalancerClient only picks the instance; HTTP calls still use RestTemplate. |

---

## üß† Summary

| Concept | Description |
| --- | --- |
| **DiscoveryClient** | Lists all service instances from Eureka |
| **LoadBalancerClient** | Picks one instance automatically |
| **Eureka Server** | Central registry |
| **RestTemplate** | Makes HTTP call |
| **Cart Service** | Producer service |
| **Order Service** | Consumer service |
| **Algorithm Used** | Round Robin (default) |

---